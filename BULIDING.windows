#!/bin/sh

# set IP address to 192.168.10.11
# set DNS to 8.8.8.8

# install cygwin
# install python 2.7
# install py2exe
# install openssl


/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P asciidoc
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P bash
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P binutils
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P bzip2
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P ca-certificates
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P coreutils
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P curl
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P cygwin
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P gcc
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P gcc-core
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P gcc-g++
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P gcc-mingw
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P gcc-mingw-g++
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P git
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P gnupg
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P grep
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P gzip
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P libboost-devel
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P libgmp-devel
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P m4
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P make
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P mingw-gcc-core
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P patch
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P perl
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P tar
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P unzip
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P wget
/cygdrive/c/Users/vagrant/Desktop/setup-x86.exe -q -P zip

cp /usr/bin/i686-pc-mingw32-gcc-4.7.3 /usr/bin/gcc


mkdir -p /vagrant


#cd /vagrant
#curl http://softlayer-dal.dl.sourceforge.net/project/boost/boost/1.55.0/boost_1_55_0.tar.gz > boost_1_55_0.tar.gz
#tar zxvf boost_1_55_0.tar.gz
#cd boost_1_55_0
#./b2 -j`nproc`./te 


# see: https://github.com/kpdyer/fteproxy/issues/71
echo "[build]" > /cygdrive/c/Python27/Lib/distutils/distutils.cfg
echo "compiler=mingw32" >> /cygdrive/c/Python27/Lib/distutils/distutils.cfg

# see: https://github.com/kpdyer/fteproxy/issues/72
sed -i -e 's/ -mno-cygwin//g' /cygdrive/c/Python27/Lib/distutils/cygwinccompiler.py


cd ~
curl https://pypi.python.org/packages/source/s/setuptools/setuptools-1.1.6.tar.gz > setuptools-1.1.6.tar.gz
tar zxvf setuptools-1.1.6.tar.gz
cd setuptools-1.1.6
/cygdrive/c/Python27/python setup.py install


cd /vagrant
curl https://pypi.python.org/packages/source/p/pip/pip-1.4.1.tar.gz > pip-1.4.1.tar.gz
tar zxvf pip-1.4.1.tar.gz
cd pip-1.4.1
/cygdrive/c/Python27/python setup.py install


#cd /vagrant
#curl https://ftp.gnu.org/gnu/gmp/gmp-5.1.3.tar.bz2 > gmp-5.1.3.tar.bz2
#bzip2 -d gmp-5.1.3.tar.bz2
#tar xvf gmp-5.1.3.tar
#cd gmp-5.1.3
#./configure
#make -j`nproc`
#make install


cd /vagrant
curl http://www.mpir.org/mpir-2.6.0.tar.bz2 > mpir-2.6.0.tar.bz2
bzip2 -d mpir-2.6.0.tar.bz2
tar xvf mpir-2.6.0.tar
cd mpir-2.6.0
./configure
make -j`nproc`
make install


export C_INCLUDE_PATH=/usr/local/include
export LD_LIBRARY_PATH=/usr/lib:/usr/local/lib

cd /vagrant
curl http://www.mpfr.org/mpfr-current/mpfr-3.1.2.tar.gz > mpfr-3.1.2.tar.gz
tar zxvf mpfr-3.1.2.tar.gz
cd mpfr-3.1.2
./configure
make -j`nproc`
make install


# see: https://github.com/kpdyer/fteproxy/issues/73
sed -i /cygdrive/c/Python27/Lib/distutils/cygwinccompiler.py -e 's/-mno-cygwin//g'
sed -i /usr/i686-pc-mingw32/sys-root/mingw/include/io.h -e 's/off64_t/_off64_t/g'
sed -i /usr/i686-pc-mingw32/sys-root/mingw/include/unistd.h -e 's/off_t/_off_t/g'


cd /vagrant
curl https://ftp.dlitz.net/pub/dlitz/crypto/pycrypto/pycrypto-2.6.tar.gz > pycrypto-2.6.tar.gz
tar zxvf pycrypto-2.6.tar.gz
cd pycrypto-2.6
CROSS_COMPILE=i686-pc-mingw32- ./configure shared mingw
/cygdrive/c/Python27/python setup.py build -cmingw32
/cygdrive/c/Python27/python setup.py install


# dodgy inc/lib dirs
cd /vagrant
curl https://gmpy.googlecode.com/files/gmpy2-2.0.2.zip > gmpy2-2.0.2.zip
unzip gmpy2-2.0.2.zip
cd gmpy2-2.0.2
# see: https://github.com/kpdyer/fteproxy/issues/74
sed -i -e "s/incdirs\ =\ \['\.\/src'\]/incdirs\ =\ \['\.\/src','\/usr\/local\/include'\]/g" setup.py
sed -i -e "s/libdirs\ =\ \[\]/libdirs\ =\ \['\/usr\/local\/lib'\]/g" setup.py
/cygdrive/c/Python27/python setup.py --nompfr build -cmingw32
/cygdrive/c/Python27/python setup.py install


/cygdrive/c/Python27/Scripts/pip install obfsproxy
/cygdrive/c/Python27/Scripts/pip install pyptlib
/cygdrive/c/Python27/Scripts/pip install pyinstaller


cd /vagrant
git clone https://github.com/kpdyer/fteproxy.git
cd fteproxy
make -j`nproc`
